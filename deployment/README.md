# Deployment of Flare Networks smart contracts

This document describes local deployment procedures for *Flare Network* smart contracts.

## Structure of folders

- `chain-config` - deployment configuration JSON files containing relevant parameters. These are deploy inputs.
- `deploys` - addresses of the deployed contracts. Each deployed contract is labeled. These are deploy outputs.
- `scripts` - deployment related scripts.
- `test` - tests verifying whether a deployment is correct. Triggered after deployment.

## Local deployment

In order to deploy the contracts to the network, local deployment of a *Flare Network* node(s) must be first run.

### Test accounts

Private keys loaded with balances for the `scdev` network are in file `test-1020-accounts.json`.

### Deploying smart contracts

- Use this repository.
- Make sure the `scdev` network is running and the node(s) are up.
- Work on branch `master`.
- Make sure *Yarn* package manager is installed. The recommended version is v1.22.10 or higher.
- Recommended `node` version is v14.15.4 or higher.
- Make sure node packages are installed, i.e. run `yarn`.
- To carry out the deployment, important private keys and settings must be defined in `.env` file. Use `.env-template` as a template for a custom `.env` file. Note that in `.env-template` the genesis governance private key matching the `scdev` network is already provided. The other two private keys should be provided by the deployer. When testing one can use private keys from `test-2020-accounts.json`.
- Check `deployment/chain-config/scdev.json` for possible changes of deployment configuration parameters. Update the file if needed to tweak the deployment. To see the description of a specific parameter either hover it with the mouse cursor in `scdev.json` file or check the [chain parameters](chain-config/chain-parameters.json) file.
- Run a deploy onto the running *Flare network*: `yarn deploy_local_scdev`. During the deploy, deployed contracts' addresses will be printed out. The script also runs some simple tests after the deployment. If some tests fail, the deployment might be faulty, or the deployment script could be broken (note that it is still under development).

## Usage

Use *web3* or *ethers* libraries to connect to the network. To obtain ABIs (Application Binary Interfaces) for contracts, use `artifacts/contracts` folder, which is generated by Solidity compilation. Addresses for the deployed contracts are available in `deployment/deploys/scdev.json`. Each deployment contract has a label which is more or less self explanatory. As RPC URL use `http://127.0.0.1:9660/ext/bc/C/rpc`.

Note that when sending transactions either by using *Web3*, *ethers* or relevant *web3* wrappers in *truffle*, obtaining the transaction receipt is not a confirmation that transaction was mined. In addition to obtaining the receipt, it must be verified that the sending account nonce had increased. One can use a wrapper like `waitFinalize3` from [deploy-utils](scripts/deploy-utils.ts) that waits until nonce increases. In order to send transactions faster, nonce management and waiting for receipts must be done manually. Adding to that, a 1-node chain will usually run faster and with less issues, hence it is preferred for tests.

Data providers can further check the proposed *Flare Price Provider* implementation at https://github.com/flare-foundation/FTSO-price-provider.

